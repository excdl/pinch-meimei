<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>智能打卡系統</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
body { font-family: Arial; background:#f7f7f7; display:flex; justify-content:center; padding:25px; margin:0;}
.card { background:white; width:95%; max-width:480px; box-shadow:0 8px 25px rgba(0,0,0,0.12); border-radius:18px; padding:25px 20px; display:flex; flex-direction:column; align-items:center; gap:20px;}
#userInfo { font-size:26px; font-weight:bold; }
#statusInfo { font-size:20px; padding:6px 18px; border-radius:30px; display:inline-block; font-weight:bold;}
#dateTime { font-size:22px; }
#modeSelect { display:flex; gap:12px; margin:15px 0;}
#modeSelect button { flex:1; padding:12px 0; font-size:20px; border-radius:10px; cursor:pointer; font-weight:bold; border:none; }
#clockBtn { width:120px; height:120px; border-radius:50%; font-size:24px; font-weight:bold; border:none; cursor:pointer; color:white; transition:0.3s;}
#clockBtn.start{background:linear-gradient(145deg, #3498db, #2980b9);}
#clockBtn.end{background:linear-gradient(145deg, #2ecc71, #27ae60);}
#todayRecords { width:100%; background:#fafafa; border-radius:12px; padding:15px; border:1px solid #ddd; font-size:18px; cursor:pointer;}
#map {width:100%; height:200px; border-radius:12px; margin-top:10px; display:none;}
</style>
</head>
<body>
<div class="card">
    <div id="userInfo">正在獲取使用者資訊...</div>
    <div id="statusInfo"></div>
    <div id="dateTime">載入中…</div>
    <div id="modeSelect">
        <button id="gpsMode">GPS 打卡</button>
        <button id="ipMode">IP 打卡</button>
    </div>
    <button id="clockBtn" disabled>上班</button>
    <div id="map"></div>
    <div id="todayRecords" onclick="refreshTodayRecords()">今日打卡紀錄：點擊可刷新</div>
</div>

<script>
const API_ENDPOINT="https://script.google.com/macros/s/AKfycbzveR74NPq6vbDZMdGg3PimAGRSYTW3exDf3drgNqn44oaxLPb-3sVTnDl-qkh_xyQ1/exec"; //後端API
let userId="", userName="", isClockedIn=false, mode="", companyLocations=[];

// ===== 更新時間 =====
function updateDateTime(){const now=new Date();document.getElementById("dateTime").textContent=now.toLocaleString("zh-TW",{hour12:false});}
setInterval(updateDateTime,1000); updateDateTime();

// ===== LIFF 登入 =====
async function initLIFF(){
    await liff.init({liffId:"YOUR_LIFF_ID"});
    if(!liff.isLoggedIn()) await liff.login();
    const profile=await liff.getProfile();
    userId=profile.userId; userName=profile.displayName;
    document.getElementById("userInfo").textContent=`${userName} 您好`;
    document.getElementById("clockBtn").disabled=false;
    loadCompanyLocations();
    updateTodayRecords();
}

// ===== 取得公司據點 =====
async function loadCompanyLocations(){
    try{
        const res=await fetch(`${API_ENDPOINT}?action=getCompanyLocations`);
        companyLocations=await res.json(); // [{name,lat,lng,allow}]
    }catch(e){ console.error("取得公司據點失敗",e);}
}

// ===== GPS 逆地理編碼 =====
async function getAddress(lat,lng){
    try{
        const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh-TW`);
        const data=await res.json(); return data.display_name||"";
    }catch(e){ console.error("地址取得失敗",e); return"";}
}

// ===== 計算距離 (米) =====
function getDistance(lat1,lng1,lat2,lng2){
    const R=6371000;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLng=(lng2-lng1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
}

// ===== 打卡 =====
document.getElementById("clockBtn").onclick=async()=>{
    const btn=document.getElementById("clockBtn");
    const status=isClockedIn?"下班":"上班";
    let lat=0,lng=0,ip="",address="",distance=0,distanceOk=true;
    if(mode==="gps"){
        if(navigator.geolocation){
            await new Promise(res=>navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude; lng=p.coords.longitude; res();}));
            address=await getAddress(lat,lng);
            distanceOk=companyLocations.some(c=>{
                distance=getDistance(lat,lng,c.lat,c.lng);
                return distance<=c.allow;
            });
        }
    }else{
        try{ const res=await fetch("https://api.ipify.org?format=json"); ip=(await res.json()).ip; }catch(e){ ip=""; }
    }

    // 圓形按鈕顏色變化
    if(!distanceOk) btn.style.background="linear-gradient(145deg,#e74c3c,#c0392b)";
    else btn.className=isClockedIn?"end":"start";

    // 發送後端
    const payload={userId,displayName:userName,status,ip,lat,lng,address};
    try{
        const r=await fetch(API_ENDPOINT,{method:"POST",body:JSON.stringify(payload)});
        const result=await r.json();
        if(result.message.includes("成功")){
            Swal.fire({icon:"success",title:"打卡成功！",html:`<strong>時間:</strong>${result.date} ${result.time}<br><strong>地址:</strong>${address}`,timer:2000,showConfirmButton:false,backdrop:"rgba(0,0,0,0.5)"});
            isClockedIn=!isClockedIn; btn.textContent=isClockedIn?"下班":"上班";
        }else Swal.fire({icon:"error",title:"打卡失敗",html:result.message,timer:2000,showConfirmButton:false});
    }catch(e){console.error(e); Swal.fire({icon:"error",title:"打卡失敗",text:e.message});}
    updateTodayRecords();
};

// ===== 今日打卡紀錄 =====
async function updateTodayRecords(){
    const today=(new Date()).toLocaleDateString("zh-TW").replace(/\//g,"/");
    try{
        const res=await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data=await res.json();
        const container=document.getElementById("todayRecords");
        if(!data.length){ container.innerHTML="今日打卡紀錄：無"; return;}
        container.innerHTML="今日打卡紀錄：<br>"+data.map(r=>{
            return `${r.status} ${r.time} ${r.address?`(地址:${r.address})`:""} ${r.ip?`(IP:${r.ip})`:""} ${r.isMakeup?"(補打卡)":""}`;
        }).join("<br>");
    }catch(e){ console.error(e); document.getElementById("todayRecords").innerHTML="今日打卡紀錄：讀取失敗";}
}
function refreshTodayRecords(){updateTodayRecords();}

// ===== 模式選擇 =====
document.getElementById("gpsMode").onclick=()=>{mode="gps"; document.getElementById("map").style.display="block";}
document.getElementById("ipMode").onclick=()=>{mode="ip"; document.getElementById("map").style.display="none";}

// ===== 初始化 =====
window.onload=()=>{initLIFF();};
</script>
</body>
</html>






































































































































