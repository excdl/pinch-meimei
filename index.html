<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>鮮食Go LIFF 下單</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <h2>今日商品清單</h2>
  <div id="product-list"></div>
  <h3>購物車</h3>
  <div id="cart-list"></div>
  <button id="checkoutBtn">下單</button>

  <script>
    let liffUserId, liffUserName;
    let cart = [];

    async function initLiff() {
      await liff.init({ liffId: "你的LIFF_ID" });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      liffUserId = profile.userId;
      liffUserName = profile.displayName;
      loadProducts();
    }

    async function loadProducts() {
      const res = await fetch("https://script.google.com/macros/s/AKfycbzPn4ii6_R0vgkw6vTbEiS8y6Hbjw-rlOn5HfGzH7P4PoDNQX977QTdH4faiUuVzLgqPQ/exec");
      const data = await res.json();
      const productListDiv = document.getElementById("product-list");
      data.products.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `${p.name} - $${p.price} (庫存: ${p.stock}) 
          <input type="number" min="1" max="${p.stock}" value="1" id="qty-${p.name}"> 
          <button onclick="addToCart('${p.name}', ${p.price}, ${p.stock})">加入購物車</button>`;
        productListDiv.appendChild(div);
      });
    }

    function addToCart(name, price, stock) {
      const qty = parseInt(document.getElementById(`qty-${name}`).value);
      if(qty > stock) { alert("庫存不足"); return; }
      const existing = cart.find(i => i.name === name);
      if(existing) existing.qty += qty;
      else cart.push({name, price, qty});
      renderCart();
    }

    function renderCart() {
      const cartDiv = document.getElementById("cart-list");
      cartDiv.innerHTML = "";
      cart.forEach(i => {
        const div = document.createElement("div");
        div.innerText = `${i.name} x ${i.qty} = ${i.qty*i.price}`;
        cartDiv.appendChild(div);
      });
    }

    async function checkout() {
      if(cart.length === 0){ alert("購物車空"); return; }
      const total = cart.reduce((sum,i)=>sum+i.price*i.qty,0);
      const orderId = "ORD" + Date.now();
      const postData = {
        orderId,
        userId: liffUserId,
        userName: liffUserName,
        items: cart,
        totalAmount: total,
        pickupMethod: "宅配", // 可改成用戶選擇
        contact: "0912345678",
        address: "台北市XXX"
      };
      const res = await fetch("你的 Apps Script 網址", {
        method: "POST",
        body: JSON.stringify(postData),
        headers: {"Content-Type":"application/json"}
      });
      const result = await res.json();
      if(result.status === "success") alert("下單成功！");
      else alert("錯誤: " + result.message);
    }

    document.getElementById("checkoutBtn").addEventListener("click", checkout);
    initLiff();
  </script>
</body>
</html>
