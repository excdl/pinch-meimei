<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¥‡å¯æ™ºèƒ½æ‰“å¡ç³»çµ±</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body { 
    font-family: Arial; 
    background:#f7f7f7;
    display:flex; 
    justify-content:center; 
    padding:25px; 
    margin:0;
}
.card {
    background:white;
    width:95%;
    max-width:480px;
    box-shadow:0 8px 25px rgba(0,0,0,0.12);
    border-radius:18px;
    padding:25px 20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
}
#userInfo { font-size:26px; font-weight:bold; }
#dateTime { font-size:22px; }
.info {
    width:100%;
    display:flex;
    justify-content:space-between;
    font-size:18px;
}
.badge {
    padding:4px 12px;
    border-radius:20px;
    font-weight:bold;
}
.ok { background:#2ecc71; color:white; }
.err { background:#e74c3c; color:white; }
#todayRecords {
    width:100%;
    background:#fafafa;
    border-radius:12px;
    padding:15px;
    border:1px solid #ddd;
    font-size:18px;
    cursor:pointer;
}
.circleBtn {
    width:130px; 
    height:130px; 
    border-radius:50%; 
    font-size:24px; 
    font-weight:bold; 
    border:none; 
    cursor:pointer; 
    transition:0.3s;
}
.circleBtn.on { background:#3498db; color:white; }
.circleBtn.off { background:#2ecc71; color:white; }
.circleBtn.bounce { animation: bounce 0.4s ease; }
@keyframes bounce {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.1); }
    50%  { transform: scale(0.95); }
    70%  { transform: scale(1.05); }
    100% { transform: scale(1); }
}
@media(max-width:420px){
    #userInfo { font-size:22px; }
    #todayRecords { font-size:16px; }
}
</style>
</head>
<body>

<div class="card">
    <div id="userInfo">æ­£åœ¨ç²å–ä½¿ç”¨è€…è³‡è¨Š...</div>
    <div id="dateTime">è¼‰å…¥ä¸­â€¦</div>

    <div class="info">ğŸ¢ é€£ç·šæ“šé»ï¼š<span id="company" class="badge err">è¼‰å…¥ä¸­</span></div>
    <div class="info">ğŸ“ è·é›¢å…¬å¸ï¼š<b id="distanceText">--</b> å…¬å°º</div>
    <div class="info">æ‰“å¡ç¯„åœï¼š<span id="range" class="badge err">åˆ¤æ–·ä¸­</span></div>

    <button id="btnClock" class="circleBtn on">ä¸Šç­</button>

    <div id="todayRecords" onclick="updateTodayRecords()">
        ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šé»æ“Šåˆ·æ–°
    </div>
</div>

<script>
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbx2RozAfSR66nhWxYDVwWdrBoG927fO4eusE2h3hYh869opULnP3qxbT_SjvW9Oat2E/exec";
let userId="", userName="";
let isClockIn = true;

// ===== æ›´æ–°æ™‚é–“ =====
function updateDateTime(){
    const now = new Date();
    document.getElementById("dateTime").textContent = now.toLocaleString("zh-TW",{hour12:false});
}
setInterval(updateDateTime,1000);
updateDateTime();

// ===== åˆå§‹åŒ– LIFF =====
async function initLIFF(){
    await liff.init({liffId:"YOUR_LIFF_ID"});
    if(!liff.isLoggedIn()) await liff.login();
    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    document.getElementById("userInfo").textContent = `${userName} æ‚¨å¥½`;
}

// ===== å–å¾— IP =====
async function getIP(){
    const cache = sessionStorage.getItem("myIP");
    if(cache) return cache;
    try{
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        sessionStorage.setItem("myIP",data.ip);
        return data.ip;
    }catch{return "";}
}

// ===== æ›´æ–°å…¬å¸è³‡è¨Š UI =====
function updateCompanyUI(data){
    const c = document.getElementById("company");
    const r = document.getElementById("range");
    const d = document.getElementById("distanceText");

    c.innerText = data.nearestCompany || "æœªçŸ¥é€£ç·š";
    c.className = "badge " + (data.nearestCompany?"ok":"err");

    d.innerText = data.distance!==undefined?data.distance:"--";

    if(data.rangeStatus==="æ­£å¸¸"){
        r.innerText = "å¯æ‰“å¡ç¯„åœ";
        r.className = "badge ok";
    }else{
        r.innerText = "éæ‰“å¡ç¯„åœ";
        r.className = "badge err";
    }
}

// ===== å³æ™‚è·é›¢æª¢æŸ¥ =====
async function checkDistanceOnly(){
    const ip = await getIP().catch(()=> "");
    if(!navigator.geolocation){
        updateCompanyUI({nearestCompany:"æœªçŸ¥é€£ç·š", distance:"--", rangeStatus:"ç•°å¸¸"});
        return;
    }
    navigator.geolocation.getCurrentPosition(async pos=>{
        const url = `${API_ENDPOINT}?action=check&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}&ip=${ip}`;
        try{
            const res = await fetch(url);
            const data = await res.json();
            updateCompanyUI(data);
        }catch(e){
            updateCompanyUI({nearestCompany:"æœªçŸ¥é€£ç·š", distance:"--", rangeStatus:"ç•°å¸¸"});
        }
    }, err=>{
        updateCompanyUI({nearestCompany:"æœªçŸ¥é€£ç·š", distance:"--", rangeStatus:"ç•°å¸¸"});
    });
}

// ===== æ‰“å¡ =====
async function performClock(){
    const ip = await getIP();
    if(!navigator.geolocation){ Swal.fire("âš  ç„¡æ³•å–å¾—ä½ç½®"); return; }
    navigator.geolocation.getCurrentPosition(async pos=>{
        const gps = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        const status = isClockIn?"ä¸Šç­":"ä¸‹ç­";
        try{
            const res = await fetch(API_ENDPOINT,{
                method:"POST",
                body: JSON.stringify({userId,userName,ip,status,gps})
            });
            const data = await res.json();

            Swal.fire({icon:"success", title:data.message, html:`${data.date} ${data.time}`, timer:2000, showConfirmButton:false});
            updateCompanyUI(data);

            isClockIn = !isClockIn;
            const btn = document.getElementById("btnClock");
            btn.textContent = isClockIn?"ä¸Šç­":"ä¸‹ç­";
            btn.className = `circleBtn ${isClockIn?"on":"off"}`;
            btn.classList.add("bounce");

            updateTodayRecords();
        }catch(e){
            Swal.fire("âš  æ‰“å¡å¤±æ•—");
        }
    }, err=>{
        Swal.fire("âš  ç„¡æ³•å–å¾—GPSä½ç½®");
    });
}

// ===== ä»Šæ—¥æ‰“å¡ç´€éŒ„ =====
async function updateTodayRecords(){
    const today = new Date().toLocaleDateString("zh-TW").replace(/\//g,"/");
    try{
        const res = await fetch(`${API_ENDPOINT}?action=getToday&userId=${userId}&date=${today}`);
        const data = await res.json();
        const container = document.getElementById("todayRecords");
        if(!data.length){container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šç„¡"; return;}
        container.innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼š<br>"+data.map(r=>`${r.status} ${r.time} ${r.method} ${r.ip}`).join("<br>");
    }catch{
        document.getElementById("todayRecords").innerHTML="ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼šè®€å–å¤±æ•—";
    }
}

document.getElementById("btnClock").onclick = performClock;

// ===== åˆå§‹åŒ–é é¢ =====
window.onload = async ()=>{
    await initLIFF();
    checkDistanceOnly();              // æ‰“å¡å‰å³æ™‚é¡¯ç¤ºè·é›¢
    setInterval(checkDistanceOnly,15000); // æ¯15ç§’è‡ªå‹•æ›´æ–°è·é›¢
    updateTodayRecords();             // é¡¯ç¤ºä»Šæ—¥æ‰“å¡ç´€éŒ„
};
</script>

</body>
</html>











































































































































































































































































